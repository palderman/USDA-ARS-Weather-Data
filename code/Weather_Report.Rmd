---
title: "Weather Data Report"
author: "Phil Alderman, Ryan Earp, and Katherine Haile"
date: "12/2/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(stringr)
library(janitor)
library(chron)
library(lubridate)
library(tidyverse)
library(car)
```


# Data Consolidation

  The first task to combine the excel sheets created by the library staff from the paper documents was achieved using an function we created in R. The filename of the document was used as the argument of the function, and the read_excel and read_ods functions were used to assign the file to a temporary dataframe called raw. The raw dataframes were then subset to exclude the summary data and column names used in the original documents and clean variable names were assigned to the columns. Due to the variation in characters in some of the numerical columns, these were coerced to a numeric form and the original columns were labeled as such. Columns to record the year, month, observer were assigned to the corresponding cells in the original document. The overall date was also combined and the times for the beginning and ending time of rain events were set as such. Finally, the date was set as the first column and the year, month, and day columns were removed.
  This function was then used to read in all of the original files and create a single .csv file. The file names were extracted from the raw data folder and ensured only the correct files were selected. This list was then fed into the read_wth_data function and arranged by date.

```{r import_functions}
read_wth_data <- function(file_name){
  if(str_detect(file_name, "1937-11")){
    sheet = "Nov. 1937"
  }else{
    sheet = 1
  }
  if(str_detect(file_name, "1896-01")){
    cshift <- 1
  }else{
    cshift <- 0
  }
  if(str_detect(file_name, "\\.ods$")){
    raw <- read_ods(file_name, col_names = FALSE, sheet = sheet) %>% 
      as_tibble() %>% 
      mutate(across(where(is.numeric), .fns = as.character))
  }else{
    raw <- read_excel(file_name, col_names = FALSE, sheet = sheet)
  }
  wdata <- raw[30:60, 1:14] %>% 
    rename_with(.fn = ~c("day", "temp_maximum", "temp_minimum", "temp_range", "temp_set_max", 
                    "precip_time_of_beginning", "precip_time_of_ending", "precip_amount",
                    "precip_snowfall_in_inches", "precip_snow_depth_tobs",
                    "wind_dir_tobs", "weather_state_tobs", "wind_dir_day", "weather_state_day")) %>% 
    mutate(across(c(temp_maximum, temp_minimum, temp_range, temp_set_max,
                    precip_amount, precip_snowfall_in_inches,
                    precip_snow_depth_tobs),
                  list(num = as.numeric))) %>% 
    rename_with(c(temp_maximum, temp_minimum, temp_range, temp_set_max,
                  precip_amount, precip_snowfall_in_inches,
                  precip_snow_depth_tobs,
                  precip_time_of_beginning, precip_time_of_ending),
                .fn = ~str_c(.,"_orig")) %>% 
    rename_with(matches("_num$"),
                .fn = ~str_remove(.,"_num$")) %>% 
    mutate(year = sanitize_year(as.character(raw[3, 4 + cshift])),
           month = sanitize_month(as.character(raw[3, 2 + cshift])),
           observer = as.character(raw[64, 2]),
           date = mdy(paste(month, day, year)),
           precip_time_of_beginning = format(times(as.numeric(precip_time_of_beginning_orig))),
           precip_time_of_ending = ifelse(is.na(as.numeric(precip_time_of_ending_orig)),
                                          precip_time_of_ending_orig,
                                          format(times(as.numeric(precip_time_of_ending_orig)))),
           wind_dir_day = sanitize_wind_dir(wind_dir_day),
           wind_dir_tobs = sanitize_wind_dir(wind_dir_tobs)) %>% 
    select(date, everything(), -c(day, month, year))
    
return(wdata)
}


source("code/read_weather_data.R")
wth_data <- list.files("data/raw/Weather Record",
                        "^[0-9]{4}$",
                        full.names = TRUE) %>% 
   map(~list.files(., "(\\.xlsx)|(\\.ods)", full.names = TRUE)) %>% 
   unlist() %>% 
   str_subset("(1893_04\\.xlsx)|(~\\$)", negate = TRUE) %>% 
   tibble(file_path = .) %>% 
   mutate(imported_data = map(file_path, ~try(read_wth_data(.)))) %>% 
   unnest(imported_data) %>% 
   arrange(date)

wth_data %>%
   filter(!is.na(date)) %>% 
   arrange(date) %>% 
   write_csv("data/processed/imported_weather_data_1893-1940.csv")
```

# Fixed Errors in Import Process

  During the import process, some challenges were encountered in reading in the files. Two different types of files were used to document the written documents, excel and ods. Due to this, two different functions were needed to read in the files to R. Additionally, varying naming conventions for the files were used throughout the years with some duplicated, so the file list needed to be subsetted to only include the desired files.
  Additionally, some errors were reported when trying to read in some of the files. One file had the sheet name labeled as the month and year instead of sheet 1 like the rest, so an exception was needed for this file. Another file had the summary titles in column A repeated in column B so the information collected from this needed to be shifted to the right one. 
  After an initial summary of the data set, it was observed that there were several entries were recorded after the year 2000 and others the date was NA. Further investigation found errors that were corrected in code. One file contained the incorrect year in the year cell. Others had varying errors in the month column of the document. This occurred from either misspelling of the month or using a misspelled abbreviation caused the function to incorrectly assign the year.
```{r fix_errors}
sanitize_wind_dir <- function(wind_dir){
  clean_wind_dir <- str_replace_all(wind_dir, c("( *\\& *)|( *â€“ *)|( *\\+ *)|(;(?=[^ ]))" = "; ",
                                                "Wind direction at time of observation" = "W",
                                                "East" = "E",
                                                "South" = "S",
                                                "Sw" = "SW",
                                                "SS" = "SW",
                                                "ES" = "SE",
                                                "Souh" = "S",
                                                "NR" = "NE")) %>% 
    na_if("-") %>% 
    na_if("data Missing") %>% 
    na_if("no entry") %>% 
    na_if("None")
  return(clean_wind_dir)
}

sanitize_year <- function(year){
  if(year == "2021"){
    year <- "1921"
  }
  return(year)
}

sanitize_month <- function(month){
  if(month %in% c("Fabruary", "Feburary")){
    month <- "February"
  }else if(month %in% c("Semptember", "Spet.")){
    month <- "September"
  }
  return(month)
}

```

# Other Observations
While going through the dataset, there were several common data entry errors we noticed. For instance, a quotation mark (") implies that the entry is the same as the row above, a dash (-) implies that the data is missing/NA, 

```{r other_observatioins}

```

                         
# Specific Column Problems
## Wind Direction at Time of Observation (wind_dir_tobs)  

```{r wind_dir_tobs}
wth_data <- read_csv("../data/processed\\imported_weather_data_1893-1940.csv")

```


## Wind Direction for the Day (wind_dir_day)
The column for wind direction for the day was evaluated for errors and some problems were encountered. Though the instructitons only called for one dirrection, many entries have two or more wind directions for the single day. Also, it seems that on some data sheets the only wind direction recorded for the day was in the Wind Direction at Time of Observation column, and the Wind Direction for the Day column includes extra notes related to the State of Weather column by including entries such as snow, thunderstorm, misting, ect. This is a problem that will need to be corrected.

```{r wind_dir_day}
wind_dir <- wth_data %>% 
  select(wind_dir_day) %>% 
  unique()
```


## Weather State for the Day (weather_state_day)
There were 49 factors of this variable in the final data set. The original instructions call for only using Cloudy, Partly cloudy, and Clear for the state of the weather. Several of the unique values were just misspellings of one of these three factors. There are several other factors that describe the state of the weather but do not fall under one of the three categories. There are also multiple entries that classify how Partly Cloudy the weather is in different fractions.
```{r weather_state_day}
bad_states <- wth_data %>% 
  select(weather_state_day) %>%
  unique() 

# Changing misspellings to Clear
wth_data[wth_data$weather_state_day %in% c("clear","CLear","Clean", "Cleaer", "Cear", "Ckear", "Celar", "Cler", "lear", "N"),"weather_state_day"]<-"Clear"

#Changing misspellings of Cloudy
wth_data[wth_data$weather_state_day %in% c("Coudy","cloudy","Cldouy", "Clouody", "Cludy"),"weather_state_day"]<-"Cloudy"

#Changing misspellings of Partly Cloudy
wth_data[wth_data$weather_state_day %in% c("PartlyCloudy","Partley Cloudy","Parlty Cloudy", "Partlly Cloudy", "partly Cloudy", "PtCloudy"),"weather_state_day"]<-"Partly Cloudy"

wth_data$weather_state_day %>% 
  na_if("-")


wth_data$Number[Wildlife$Animal == "Cow"] <- NA
1923-04-04


wth_data %>%
  select(date, weather_state_day) %>% 
  filter(weather_state_day == "//")

wth_data %>% 
  group_by(weather_state_day) %>% 
  ggplot(aes(x = weather_state_day)) +
  geom_bar()
```


## Maximum Temperature (temp_maximum)
```{r temp_maximum}

```


## Minimum Temperature (temp_minimum)
```{r temp_minimum}

```


## Temperature Range for the Day (temp_range)
  
```{r temp_range}

```


## Temperature Set Max (temp_set_max)

```{r temp_set_max}

```


## Precipitation Amount (precip_amount)
There were six values found that were likely transcribed incorrectly from the original data sheet. Four of the highest values simply needed a decimal placed before the first number to make them correct. The fifth and sixth incorrect values, which were the next highest ones in ranking order, were difficult to interpret from the original handwriting. However, these values are not correct when compared to the monthly totals that are listed. The highest valuese needing a decimal point moved were corrected and the other ones were not modified. It may be worthwhile to import the monthly totals entered in the data sheets and compare them to the calculated totals from each entry for each respective month, which would help ensure that there are no other mistyped data entries that are not as easily noticeable.
```{r precip_amount}
wth_data %>% 
  ggplot()+
  geom_line(aes(x = date, y = precip_amount)) 

precip <- wth_data %>% 
  select(date, precip_amount) %>% 
  drop_na() %>% 
  arrange(desc(precip_amount))

# Fixing the large values 
wth_data$precip_amount[wth_data$precip_amount == 78.00] <- .78
wth_data$precip_amount[wth_data$precip_amount == 58.00] <- .58
wth_data$precip_amount[wth_data$precip_amount == 50.00] <- .50
wth_data$precip_amount[wth_data$precip_amount == 45.00] <- .45
```


## Snowfall in Inches (precip_snowfall_in_inches)
There does not appear to be any noticeable problems in this column.

```{r precip_snowfall_in_inches}
wth_data %>% 
  ggplot()+
  geom_line(aes(x = date, y = precip_snowfall_in_inches))

snow <- wth_data %>% 
  select(date, precip_snowfall_in_inches) %>% 
  drop_na() %>% 
  arrange(desc(precip_snowfall_in_inches))

```


## Snow Depth at Time of Observation (precip_snow_depth_tobs)
All values in this column seem to be reasonable amounts.
```{r precip_snow_depth_tobs}

wth_data %>% 
  ggplot()+
  geom_line(aes(x = date, y = precip_snow_depth_tobs))

snow <- wth_data %>% 
  select(date, precip_snow_depth_tobs) %>% 
  drop_na() %>% 
  arrange(desc(precip_snow_depth_tobs))

```



